<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js@1.3.3/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/jszip/3.1.5/jszip.min.js"></script>
</head>
<body>
  <button onclick="chooseDir()">Choose folder</button>
  <button onclick="minifyAll()">Minify</button>
  <button onclick="downloadAll()">Download</button>
  <script>
    function chooseDir() {
      window.chooseDirectory(function(dir) {
        readAllJsonFiles(dir);
      });
    }
    function readAllJsonFiles(dir) {
      var files = [];
      var reader = dir.createReader();
      var results = [];
      reader.readEntries(function(entries) {
        for (var i = 0; i < entries.length; i++) {
          if (entries[i].name.endsWith('.json')) {
            files.push(entries[i]);
          }
        }
        if (files.length) {
          minifyFiles(files.shift());
        } else {
          console.log('No json files found.');
        }
      });
      function minifyFiles(file) {
        file.file(function(file) {
          var reader = new FileReader();
          reader.onload = function(event) {
            var json = JSON.parse(event.target.result);
            var minified = JSON.stringify(json);
            var blob = new Blob([minified], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
            if (files.length) {
              minifyFiles(files.shift());
            }
          };
          reader.readAsText(file);
        });
      }
    }
    function downloadAll() {
      var zip = new JSZip();
      function processFiles(entries) {
        for (var i = 0; i < entries.length; i++) {
          var entry = entries[i];
          if (entry.isDirectory) {
            processFiles(entry.createReader().readEntries.bind(entry.createReader()));
          } else {
            entry.file(function(file) {
              zip.file(entry.name, file);
              if (i === entries.length - 1) {
                zip.generateAsync({type:"blob"})
                  .then(function(content) {
                    saveAs(content, "minified.zip");
                  });
              }
            });
          }
        }
      }
      var dir = DirectoryEntry.root;
      processFiles(dir.createReader().readEntries.bind(dir.createReader()));
    }
  </script>
</body>
</html>
